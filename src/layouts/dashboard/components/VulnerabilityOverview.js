import React from "react";
import { Card, Grid } from "@mui/material";
import Chart from "react-apexcharts";
import { FaBug } from "react-icons/fa";

import VuiBox from "components/VuiBox";
import VuiTypography from "components/VuiTypography";

function VulnerabilityOverview({ stats }) {
  if (!stats || !stats.byClass || stats.byClass.length === 0) return null;

  const { top3, byClass } = stats;
  const labels = byClass.map((v) => v.type);
  const series = byClass.map((v) => v.count);
  const totalCount = series.reduce((a, b) => a + b, 0);

  const fontFamily = "'Poppins', 'Noto Sans KR', 'Fira Code', sans-serif";

  const donutChartOptions = {
    chart: {
      type: "donut",
      toolbar: { show: false },
      fontFamily, // ✅ 전체 차트 폰트 적용
    },
    labels,
    tooltip: {
      enabled: true,
      custom: ({ series, seriesIndex, w }) => {
        const value = series[seriesIndex];
        const label = w.globals.labels[seriesIndex];
        const total = series.reduce((a, b) => a + b, 0);
        const percent = ((value / total) * 100).toFixed(1);
        return `
          <div style="padding: 6px 10px; background: rgba(0,0,0,0.85); color: white; border-radius: 6px; font-size: 12px; font-family: ${fontFamily};">
            <strong>${label}</strong>: 
            <span style="color: #00e3ff; font-weight: bold;">
              ${value} issues (${percent}%)
            </span>
          </div>
        `;
      },
    },
    legend: { show: false },
    plotOptions: {
      pie: {
        donut: {
          size: "70%",
          labels: {
            show: true,
            name: {
              show: true,
              fontSize: "12px",
              fontWeight: 600,
              offsetY: -6,
              color: "#ffffff",
              fontFamily, // ✅ 중앙 이름 폰트
            },
            value: {
              show: true,
              fontSize: "13px",
              fontWeight: "bold",
              color: "#00e3ff",
              offsetY: 6,
              fontFamily, // ✅ 중앙 값 폰트
              formatter: (val) => {
                const percent = ((val / totalCount) * 100).toFixed(1);
                return `${val} (${percent}%)`;
              },
            },
            total: {
              show: true,
              label: "Total",
              fontSize: "12px",
              fontWeight: 500,
              color: "#ffffff",
              fontFamily, // ✅ 중앙 총합 폰트
              formatter: () => `${totalCount}`,
            },
          },
        },
      },
    },
    dataLabels: { enabled: false },
    stroke: { show: false },
    colors: [
      "#00c6ff", "#fbcf33", "#f53939", "#5e72e4", "#2dce89",
      "#11cdef", "#fb6340", "#8965e0", "#f5365c", "#ffa21a",
    ],
  };

  return (
    <Card
      sx={{
        overflow: "visible",
        height: "100%",
        padding: "16px",
        borderRadius: "20px",
        color: "#fff",
        background: "linear-gradient(135deg, #0f1123, #1a1d40, #3d55cc)",
        fontFamily, // ✅ 카드 전체에도 동일 폰트
      }}
    >
      <VuiTypography
        variant="lg"
        fontWeight="bold"
        mb={2}
        color="white"
        display="flex"
        alignItems="center"
        gap={1}
      >
        <FaBug />
        Vulnerability Overview
      </VuiTypography>

      <Grid container spacing={2}>
        {/* Top 3 취약점 카드 */}
        <Grid item xs={12} md={7}>
          <Grid container spacing={1}>
            {top3.map((vuln, idx) => (
              <Grid item xs={12} key={idx}>
                <VuiBox
                  display="flex"
                  alignItems="center"
                  justifyContent="space-between"
                  sx={{
                    background: "linear-gradient(135deg, #1a1c35, #272a55, #3d55cc)",
                    borderRadius: "14px",
                    padding: "14px 18px",
                    minHeight: "54px",
                  }}
                >
                  <VuiBox display="flex" alignItems="center" gap={2}>
                    <VuiBox
                      sx={{
                        backgroundColor: "#007bff",
                        color: "#fff",
                        borderRadius: "10px",
                        minWidth: "28px",
                        height: "28px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        fontWeight: "bold",
                        fontSize: "13px",
                      }}
                    >
                      {idx + 1}
                    </VuiBox>
                    <VuiTypography
                      variant="button"
                      fontWeight="medium"
                      sx={{ color: "#e0e0e0", fontSize: "14px" }}
                    >
                      {vuln.type}
                    </VuiTypography>
                  </VuiBox>

                  <VuiBox
                    sx={{
                      backgroundColor: "#3396e6ff",
                      color: "#ffffff",
                      padding: "4px 10px",
                      borderRadius: "999px",
                      fontSize: "12px",
                      fontWeight: 600,
                      minWidth: "60px",
                      textAlign: "center",
                      whiteSpace: "nowrap",
                    }}
                  >
                    {vuln.count} issues
                  </VuiBox>
                </VuiBox>
              </Grid>
            ))}
          </Grid>
        </Grid>

        {/* 도넛 차트 */}
        <Grid item xs={12} md={5}>
          <Chart
            options={donutChartOptions}
            series={series}
            type="donut"
            height={200}
          />
        </Grid>
      </Grid>
    </Card>
  );
}

export default VulnerabilityOverview;
