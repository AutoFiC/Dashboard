import React from "react";
import { Card, Grid } from "@mui/material";
import Chart from "react-apexcharts";
import { FaBug } from "react-icons/fa";

import VuiBox from "components/VuiBox";
import VuiTypography from "components/VuiTypography";

function VulnerabilityOverview({ stats }) {
  if (!stats?.byClass?.length) return null;

  const { top3, byClass } = stats;
  const labels = byClass.map(v => v.type);
  const series = byClass.map(v => v.count);
  const totalCount = series.reduce((a, b) => a + b, 0);
  const fontFamily = "'Poppins', 'Noto Sans KR', 'Fira Code', sans-serif";

  const donutChartOptions = {
    chart: { type: "donut", toolbar: { show: false }, fontFamily },
    labels,
    tooltip: {
      enabled: true,
      custom: ({ series, seriesIndex, w }) => {
        const value = series[seriesIndex];
        const label = w.globals.labels[seriesIndex];
        const percent = ((value / totalCount) * 100).toFixed(1);
        return `
          <div style="
            padding: 6px 10px;
            background: rgba(0,0,0,0.85);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-family: ${fontFamily};
          ">
            <strong>${label}</strong>:
            <span style="color: #00e3ff; font-weight: bold;">
              ${value} issues (${percent}%)
            </span>
          </div>
        `;
      },
    },
    legend: { show: false },
    plotOptions: {
      pie: {
        donut: {
          size: "70%",
          labels: {
            show: true,
            name: {
              show: true,
              fontSize: "12px",
              fontWeight: 600,
              offsetY: -6,
              color: "#ffffff",
              fontFamily,
            },
            value: {
              show: true,
              fontSize: "18px",
              fontWeight: "bold",
              color: "#00e3ff",
              offsetY: 6,
              fontFamily,
              formatter: val => {
                const percent = ((val / totalCount) * 100).toFixed(1);
                return `${val} (${percent}%)`;
              },
            },
            total: {
              show: true,
              label: "Total",
              fontSize: "15px",
              fontWeight: 500,
              color: "#ffffff",
              fontFamily,
              formatter: () => `${totalCount}`,
            },
          },
        },
      },
    },
    dataLabels: { enabled: false },
    stroke: { show: false },
    colors: [
      "#4baaf8",
      "#6ad4dd",
      "#a8d7ea",
      "#8c66ff",
      "#26ddf9ff",
      "#229ca3",
      "#3578b6",
      "#5c73e6",
      "#7b63ff",
      "#b28fff",
    ],
  };

  return (
    <Card
      sx={{
        overflow: "visible",
        height: "100%",
        p: 2,
        borderRadius: "20px",
        color: "#fff",
        background: "linear-gradient(135deg, #0f1123, #1a1d40, #3d55cc)",
        fontFamily,
      }}
    >
      <VuiTypography
        variant="lg"
        fontWeight="bold"
        mb={2}
        color="white"
        display="flex"
        alignItems="center"
        gap={1}
      >
        <FaBug />
        Vulnerability Overview
      </VuiTypography>

      <Grid container spacing={2}>
        <Grid item xs={12} md={7}>
          <Grid container spacing={1}>
            {top3.map((vuln, idx) => (
              <Grid item xs={12} key={idx}>
                <VuiBox
                  display="flex"
                  alignItems="center"
                  justifyContent="space-between"
                  sx={{
                    background: "linear-gradient(135deg, #1a1c35, #272a55, #3d55cc)",
                    borderRadius: "14px",
                    p: "14px 18px",
                    minHeight: 54,
                  }}
                >
                  <VuiBox display="flex" alignItems="center" gap={2}>
                    <VuiBox
                      sx={{
                        backgroundColor: "#007bff",
                        color: "#fff",
                        borderRadius: "10px",
                        minWidth: 28,
                        height: 28,
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        fontWeight: "bold",
                        fontSize: 13,
                      }}
                    >
                      {idx + 1}
                    </VuiBox>
                    <VuiTypography
                      variant="button"
                      fontWeight="medium"
                      sx={{ color: "#e0e0e0", fontSize: 14 }}
                    >
                      {vuln.type}
                    </VuiTypography>
                  </VuiBox>

                  <VuiBox
                    sx={{
                      backgroundColor: "#3396e6",
                      color: "#fff",
                      px: 1.25,
                      py: 0.5,
                      borderRadius: "999px",
                      fontSize: 12,
                      fontWeight: 600,
                      minWidth: 60,
                      textAlign: "center",
                      whiteSpace: "nowrap",
                    }}
                  >
                    {vuln.count} issues
                  </VuiBox>
                </VuiBox>
              </Grid>
            ))}
          </Grid>
        </Grid>

        <Grid item xs={12} md={5}>
          <Chart options={donutChartOptions} series={series} type="donut" height={200} />
        </Grid>
      </Grid>
    </Card>
  );
}

export default VulnerabilityOverview;
